<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¨×•×‘×•×˜ ××“×‘×¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ¤– ×“×‘×¨ ×¢× ×”×¨×•×‘×•×˜</h1>
  <button id="talkBtn">ğŸ¤ ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×“×‘×¨ ×¢× AI</button>
  <div id="banner">...</div>

  <script>
    const OPENAI_KEY = "sk-..."; // ğŸ”‘ ×©×™× ×›××Ÿ ××ª ×”××¤×ª×— ×©×œ×š

    function showBanner(text) {
      const banner = document.getElementById("banner");
      banner.textContent = text;
      banner.style.display = "block";
    }

    async function speak(text) {
      try {
        const res = await fetch("https://api.openai.com/v1/audio/speech", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${OPENAI_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "tts-1-hd",
            voice: "shira",
            input: text
          })
        });

        const blob = await res.blob();
        const audio = new Audio(URL.createObjectURL(blob));
        audio.play();
      } catch (err) {
        console.error("×©×’×™××” ×‘×“×™×‘×•×¨ GPT:", err);
        showBanner("âŒ ×©×’×™××” ×‘×“×™×‘×•×¨.");
      }
    }

    async function askGPT(prompt) {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${OPENAI_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            { role: "system", content: "××ª×” ×¢×•×–×¨ ×¨×•×‘×•×˜×™ ×©××“×‘×¨ ×¢×‘×¨×™×ª ×œ×™×œ×“×™×" },
            { role: "user", content: prompt }
          ]
        })
      });

      const data = await res.json();
      return data.choices?.[0]?.message?.content || "âŒ ××™×Ÿ ×ª×©×•×‘×”.";
    }

    function startListening() {
      if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'he-IL';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        let stopTimeout = setTimeout(() => {
          recognition.stop();
          showBanner("âŒ› ×œ× ×–×•×”×” ×§×•×œ - ×¢×¦×¨×ª×™ ××•×˜×•××˜×™×ª");
        }, 6000);

        recognition.onresult = async function (event) {
          clearTimeout(stopTimeout);
          const transcript = event.results[0][0].transcript.trim();
          if (!transcript) {
            showBanner("âŒ ×œ× ×§×œ×˜×ª×™ ××” ×××¨×ª.");
            return;
          }
          const reply = await askGPT(transcript);
          showBanner(reply);
          speak(reply);
        };

        recognition.onerror = function (event) {
          clearTimeout(stopTimeout);
          showBanner("âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ: " + event.error);
        };

        recognition.onend = () => clearTimeout(stopTimeout);

        recognition.start();
        showBanner("ğŸ™ï¸ ××§×©×™×‘... ×“×‘×¨ ×¢×›×©×™×•");
      } else {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "audio/*";
        fileInput.style.display = "none";

        fileInput.onchange = async () => {
          const file = fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);
          formData.append("model", "whisper-1");

          try {
            const whisperRes = await fetch("https://api.openai.com/v1/audio/transcriptions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${OPENAI_KEY}`
              },
              body: formData
            });

            const whisperData = await whisperRes.json();
            const text = whisperData.text;
            if (!text) return showBanner("âŒ ×ª××œ×•×œ × ×›×©×œ.");

            const reply = await askGPT(text);
            showBanner(reply);
            speak(reply);
          } catch (err) {
            console.error("âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×§×•×‘×¥ ×§×•×œ:", err);
            showBanner("âŒ ×©×’×™××” ×‘×©×œ×™×—×”");
          }
        };

        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
      }
    }

    document.getElementById("talkBtn").addEventListener("click", startListening);
  </script>
</body>
</html>
