<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×©×ª×ª×¤×•×ª ×‘×‘× ×™×™×ª ×”×¨×•×‘×•×˜</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>×‘× ×™×™×ª ×”×¨×•×‘×•×˜</h1>

    <p class="Description1">
        ×”×›×™×¨×• ××ª ×”×¨×•×‘×•×˜ ×”×—×™× ×•×›×™ ×©×œ× ×• â€“ ×—×‘×¨ ×—×›× ×•×™×¦×™×¨×ª×™ ×œ×™×œ×“×™×!
        ×”×¨×•×‘×•×˜ ×™×•×“×¢ ×œ×”×§×©×™×‘, ×œ×”×‘×™×Ÿ ×•×œ×“×‘×¨ ×‘×¢×‘×¨×™×ª, ××–×”×” ××—×™××ª ×›×£, ××¦×™×’ ×”×‘×¢×•×ª ×¤× ×™× ××©×ª× ×•×ª, ×¢×•× ×” ×¢×œ ×©××œ×•×ª, ××¡×¤×¨ ×¡×™×¤×•×¨×™×,
        ××©××™×¢ ×¦×œ×™×œ×™×, ×•××’×™×‘ ×‘×¦×•×¨×” ×—×›××” ×œ××¦×‘×™×.
        ×”×•× ××•×¤×¢×œ ×‘×§×œ×•×ª ×“×¨×š ××¡×š ××’×¢ ×•××™×•×¢×“ ×œ×¢×•×¨×¨ ×¡×§×¨× ×•×ª, ×œ×¤×ª×— ×©×™×—×”, ×•×œ×¢×–×•×¨ ×‘×œ××™×“×” ×—×•×•×™×™×ª×™×ª â€“ ×ª×•×š ×©××™×¨×” ×¢×œ ×ª×›× ×™× ××•×ª×××™×
        ×œ×™×œ×“×™×.
    </p>

    <div id="goDownContainer" onclick="document.getElementById('bottom-section').scrollIntoView({behavior:'smooth'})">
        <div class="goDownText">â¬‡ï¸ ×‘×•× × ×¨×“â¬‡ï¸<br> â¬‡ï¸×œ×¢×™× ×™×™×Ÿâ¬‡ï¸</div>
        <img src="images/chevron.png" class="ggg123" alt="×‘×•× × ×¨×“ ×œ×¢× ×™×™×Ÿ">
    </div>

  <h1>×©×•×—×— ×¢× GPT-4o</h1>
  <button onclick="startListening()">ğŸ¤ ×“×‘×¨ ×¢×›×©×™×•</button>
  <div id="output">...</div>


    <p class="prohct123">ğŸ‘‡××œ×• ×”×¨×›×™×‘×™× ×©× ×‘×—×¨×• ×œ×¤×¨×•×™×§×˜ğŸ‘‡</p>
    <ul>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="images/Untitled-1.png" alt="Voice Sensor"
                style="max-width: 200px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1);" />
            <br>
            <div style="font-size: 18px; color: #000000; font-weight: 500;">
                ×”××•×— ×¢×¦××• ×©×œ ×”×¤×¨×•×™×™×§×˜ ×”×¨×•×‘×•×˜×™
            </div>
            <br>
            <span style="color: #039be5; font-weight: bold;"> â‚ª1500.00 ×›×•×œ×œ ××¢"×</span>
            <br><br>
            <div style="font-size: 18px; color: #18b318; font-weight: 500;">
             (××¢×‘×“ Rspberry pi 4)<br>
               ×¨×•×‘×•×˜ ×—×›× ×–×” ×™×›×•×œ ×œ×”×™×•×ª ×××© ××‘×“×¨, ×•××¢× ×™×™×Ÿ ×‘×™××™×•×—×“ ×¢× ××¢×¨×›×ª ×”×—×™×‘×•×¨ ×©×œ×•  AI, ×”×œ×‘ ×”×¤×•×¢× ×©×œ ×”××¢×¨×›×ª.
            </div>
            <br>
        </div>
        <br><br>
        <hr style="width: 150px; border: 1px solid #ccc; margin: 20px auto;" />
    </ul>

    <h3>×©×:</h3>
    <input type="text" id="nameInput" placeholder="×”×›× ×¡ ×©×">

    <h3>×‘×—×¨ ××—×•×– ×”×©×ª×ª×¤×•×ª:</h3>
    <select id="percentSelect">
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <br><br>
    <button onclick="submitForm()">×”×©×ª×ª×£ ×‘×‘× ×™×™×ª ×”×¨×•×‘×•×˜</button>
    <br><br>
    <h3 class="ggg">ğŸ‘‡××©×ª×ª×¤×™× ×‘×¤×¨×•×™×™×§×˜ğŸ‘‡</h3>
    <table id="participantsTable">
        <thead>
            <tr>
                <th>×©×</th>
                <th>××—×•×– ×”×©×ª×ª×¤×•×ª</th>
                <th>×¡×›×•× ×‘×¤×•×¢×œ (â‚ª)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="bottom-section"></div>

    <div class="total" id="totalPercent">×¡×”"×› ×”×©×ª×ª×¤×•: 0%</div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
       // âœ… ×™×¦×™×¨×ª ×—×™×‘×•×¨ ×œ-Supabase
const client = window.supabase.createClient(
    "https://fqjfwtspitxhryirivdo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxamZ3dHNwaXR4aHJ5aXJpdmRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5NDM0MzMsImV4cCI6MjA2NTUxOTQzM30.QQPn4JthlXVF1Fb0PzqShbUpzBmA-_WJ9Zc4up4zwKg"
);

const tableBody = document.querySelector("#participantsTable tbody");
const totalPercentEl = document.getElementById("totalPercent");

// âœ… ×˜×¢×™× ×ª ××©×ª×ª×¤×™× ××”-DB
async function loadParticipants() {
    const { data, error } = await client.from("participants").select("*");
    if (error) return console.error("×©×’×™××” ×‘×˜×¢×™× ×”:", error.message);

    tableBody.innerHTML = "";
    let totalPercent = 0;
    const totalPrice = extractPricesFromHTML();

    data.forEach(part => {
        const amount = ((part.percent / 100) * totalPrice).toFixed(2);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${part.name}</td><td>${part.percent}%</td><td>${amount} â‚ª</td>`;
        tableBody.appendChild(tr);
        totalPercent += part.percent;
    });

    totalPercentEl.textContent = `×¡×”\"×› ×”×©×ª×ª×¤×•: ${totalPercent}%`;
}

// âœ… ×©×œ×™×—×ª ××©×ª×ª×£ ×—×“×©
async function submitForm() {
    const name = document.getElementById("nameInput").value.trim();
    const percent = parseInt(document.getElementById("percentSelect").value);
    if (!name || isNaN(percent)) return alert("×× × ××œ× ×©× ×•×‘×—×¨ ××—×•×– ×ª×§×™×Ÿ");

    const { error } = await client.from("participants").insert([{ name, percent }]);
    if (error) return alert("×©×’×™××” ×‘×©×œ×™×—×”: " + error.message);

    document.getElementById("nameInput").value = "";
    document.getElementById("percentSelect").selectedIndex = 0;
    await loadParticipants();
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// âœ… ××—×©×‘ ×¡×›×•× ×›×•×œ×œ ××”-HTML
function extractPricesFromHTML() {
    const spans = document.querySelectorAll("span");
    let total = 0;
    spans.forEach(span => {
        const text = span.textContent;
        let price = 0;
        if (text.includes("â‚ª")) price = parseFloat(text.replace(/[^\d.]/g, ''));
        if (text.includes("$")) {
            const match = text.match(/\$([\d.]+)/g);
            if (match) {
                match.forEach(m => {
                    const val = parseFloat(m.replace("$", ""));
                    price += val * 3.7;
                });
            }
        }
        total += price;
    });
    return total;
}


document.addEventListener("DOMContentLoaded", loadParticipants);


function speak(text) {
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "he-IL";
  utter.rate = 1.1;
  utter.pitch = 1;

  // ×”×•×¡×¤×ª ×”×©×”×™×” ×›×“×™ ×œ×•×•×“× ×˜×¢×™× ×ª ×§×•×œ×•×ª
  const waitForVoices = setInterval(() => {
    const voices = synth.getVoices();
    if (voices.length) {
      clearInterval(waitForVoices);
      const voice = voices.find(v => v.lang === "he-IL") || voices[0];
      if (voice) utter.voice = voice;
      synth.cancel();
      synth.speak(utter);
    }
  }, 100);
}






async function respondToUser(userText) {
  const lower = userText.toLowerCase();
  let match = null;

  for (const item of responses) {
    for (const keyword of item.keywords || []) {
      if (lower.includes(keyword)) {
        match = item;
        break;
      }
    }
    if (match) break;
  }

  if (match) {
    showBanner(match.response);
    match.audio ? playAudio(match.audio) : speak(match.response);
  } else {
    showBanner("×œ× ×”×‘× ×ª×™ ××•×ª×š, × ×¡×” ×©×•×‘.");
    speak("×œ× ×”×‘× ×ª×™ ××•×ª×š, × ×¡×” ×©×•×‘.");
  }
}

function startListening() {
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'he-IL';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let stopTimeout = setTimeout(() => {
      recognition.stop();
      showBanner("âŒ› ×œ× ×–×•×”×” ×§×•×œ - ×¢×¦×¨×ª×™ ××•×˜×•××˜×™×ª");
    }, 6000);

    recognition.onresult = function (event) {
      clearTimeout(stopTimeout);
      const transcript = event.results[0][0].transcript.trim();
      if (!transcript) {
        showBanner("âŒ ×œ× ×§×œ×˜×ª×™ ××” ×××¨×ª.");
        return;
      }
      console.log("ğŸ—£ï¸ ×–×•×”×” ×˜×§×¡×˜:", transcript);
      respondToUser(transcript);
    };

    recognition.onerror = function (event) {
      clearTimeout(stopTimeout);
      console.error("ğŸ™ï¸ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ:", event.error);
      showBanner("âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ: " + event.error);
    };

    recognition.onend = () => clearTimeout(stopTimeout);

    recognition.start();
    showBanner("ğŸ™ï¸ ××§×©×™×‘... ×“×‘×¨ ×¢×›×©×™×•");
  } else {
    showBanner("ğŸ™ï¸ ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×–×™×”×•×™ ×§×•×œ.");
  }
}


function playAudio(fileName) {
  const audio = new Audio(`audio/${fileName}`);
  audio.play().catch(err => {
    console.error("ğŸ”´ ×©×’×™××” ×‘×”×¤×¢×œ×ª audio:", err);
  });
}


function showBanner(text) {
  const banner = document.getElementById("banner");
  banner.textContent = text;
  banner.style.display = "block";
}

  // ×›××Ÿ ×©××™× ××ª ×ª×’×•×‘×•×ª ×”Ö¾JSON ××ª×•×š ×”×§×•×‘×¥ ×©×œ×š
    const responses = [
      {
        keywords: ["××” ×–×”", "××™×š ×–×” ×¢×•×‘×“", "××” ××ª×” ×¢×•×©×”", "××™ ××ª×”", "××™×š ×§×•×¨××™× ×œ×š", "××™×–×” ×¨×•×‘×•×˜ ××ª×”", "×ª×¡×‘×™×¨", "×ª×¡×‘×™×¨ ×œ×™", "×× ×™ ××¢×•× ×™×™×Ÿ", "××¢× ×™×™×Ÿ ××•×ª×™", "××” ××ª×” ×™×•×“×¢", "××” ××ª×” ×™×›×•×œ", "××” ×”××˜×¨×” ×©×œ×š", "××™×š ××ª×” ×¤×•×¢×œ", "××” ××ª×” ×©×•×•×”", "××” ×”×™×›×•×œ×•×ª ×©×œ×š", "×œ××” ××ª×” ×¤×”", "×œ××” ×›×“××™ ×œ×”×©×ª××©", "×¡×¤×¨ ×¢×œ×™×š", "××” ×”×™×ª×¨×•× ×•×ª ×©×œ×š", "×ª×Ÿ ××™×“×¢", "××™×“×¢ ×¢×œ×™×š", "××™×š ××©×ª××©×™× ×‘×š", "××” ××ª×” ××¦×™×¢", "××™×š ××ª×—×™×œ×™×", "×× ×™ ×¨×•×¦×” ××™×“×¢", "×× ×™ ×¨×•×¦×” ×œ×”×‘×™×Ÿ", "×‘××” ××ª×” ×¢×•×–×¨", "××” ×”×ª×¤×§×™×“ ×©×œ×š", "×›××” ×–×” ×¢×•×œ×”"],
        response: "×× ×™ ×¨×•×‘×•×˜ ×—×›× ×©× ×‘× ×” ×›×“×™ ×œ×¢×–×•×¨, ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª, ×œ×©×•×—×—, ×œ×ª×ª ××™×“×¢, ×•×œ×”×¤×•×š ××ª ×”×ª×§×©×•×¨×ª ××™×ª×š ×œ××”×™×¨×”, × ×’×™×©×” ×•× ×¢×™××”."
      },
      {
        keywords: ["×©×œ×•×", "×”×™×™", "×”×™", "×”×™×™×™", "×©×œ×•× ×¨×‘"],
        response: "×©×œ×•× ×•×‘×¨×•×š ×”×‘×! ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?"
      },
      {
        keywords: ["××” ×”×©× ×©×œ×š", "××™×š ×§×•×¨××™× ×œ×š", "××™ ××ª×”", "××™ ××ª"],
        response: "×× ×™ ×”×¨×•×‘×•×˜ ×”××“×‘×¨ ×©×œ×š. ××™×Ÿ ×œ×™ ×©× ×§×‘×•×¢ â€“ ××ª×” ×™×›×•×œ ×œ×‘×—×•×¨ ×œ×™!"
      },
      {
        keywords: ["××” ×”×©×¢×”", "×ª×’×™×“ ×œ×™ ××ª ×”×©×¢×”", "××™×–×• ×©×¢×”", "×›××” ×”×©×¢×”"],
        response: "×× ×™ ×œ× ××—×•×‘×¨ ×œ×©×¢×•×Ÿ, ××‘×œ ×”×–××Ÿ ×”×›×™ ×˜×•×‘ ×”×•× ×¢×›×©×™×•!"
      },
      {
        keywords: ["××” ××–×’ ×”××•×•×™×¨", "×”××–×’ ××•×•×™×¨", "×ª×—×–×™×ª", "×’×©×", "×©××©", "×§×¨", "×—×"],
        response: "××™×Ÿ ×œ×™ ××“ ×—×•×, ××‘×œ ×ª××™×“ × ×¢×™× ×›×©××ª×” ×¤×”!"
      },
      {
        keywords: ["××™×š ××ª×” ××¨×’×™×©", "××” ×©×œ×•××š", "××™×š ××ª ××¨×’×™×©×”", "××” ×©×œ×•××š ×”×™×•×"],
        response: "×× ×™ ××¨×’×™×© ×‘×™× ×” ××œ××›×•×ª×™×ª ××œ××” ×‘×× ×¨×’×™×” ×—×™×•×‘×™×ª!"
      },
      {
        keywords: ["×ª×¡×¤×¨ ×œ×™ ×‘×“×™×—×”", "×™×© ×œ×š ×‘×“×™×—×”", "×‘×“×™×—×”"],
        response: "×œ××” ×”×¨×•×‘×•×˜ ×œ× ×”×œ×š ×œ×‘×™×ª ×¡×¤×¨? ×›×™ ×”×•× ×›×‘×¨ ××ª×•×›× ×ª ×œ×“×¢×ª ×”×›×•×œ!"
      },
      {
        keywords: ["×œ×”×ª×¨××•×ª", "×‘×™×™", "×¡×™×•×", "×¡×’×•×¨"],
        response: "×‘×™×™ ×‘×™×™! ××—×›×” ×œ×©××•×¢ ×××š ×©×•×‘ ×‘×§×¨×•×‘!"
      },
      {
        keywords: ["×ª×•×“×”", "×ª×•×“×” ×¨×‘×”", "×ª×•×“×” ×œ×š", "×ª×•×“×” ×¢×œ ×”×¢×–×¨×”"],
        response: "×‘×©××—×”! ×ª××™×“ ×›××Ÿ ×œ×¢×–×•×¨."
      }
    ];

    function findPredefinedResponse(text) {
      const lowered = text.toLowerCase();
      for (const item of responses) {
        for (const keyword of item.keywords) {
          if (lowered.includes(keyword.toLowerCase())) {
            return item.response;
          }
        }
      }
      return null;
    }

    async function sendToWorker(text) {
      const quickReply = findPredefinedResponse(text);
      if (quickReply) {
        document.getElementById("output").textContent = quickReply;
        speak(quickReply); // ×”×©××¢×” ××™×™×“×™×ª
        return;
      }

      document.getElementById("output").textContent = "×—×•×©×‘...";
      const res = await fetch("https://lucky-grass-b400.netzach3020.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input: text })
      });

      const data = await res.json();
      const reply = data.response || "×œ× ×”×ª×§×‘×œ×” ×ª×’×•×‘×”";
      document.getElementById("output").textContent = reply;

      if (data.audio) {
        setTimeout(() => {
          const audio = new Audio(data.audio);
          audio.play();
        }, 100);
      }
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "he-IL";
      window.speechSynthesis.speak(utterance);
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "he-IL";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = function (event) {
        const text = event.results[0][0].transcript;
        document.getElementById("output").textContent = "×©××¢×ª: " + text;
        sendToWorker(text);
      };

      recognition.onerror = function (event) {
        document.getElementById("output").textContent = "×©×’×™××”: " + event.error;
      };

      recognition.start();
    }

    </script>
</body>

</html>
