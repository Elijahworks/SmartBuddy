<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×©×ª×ª×¤×•×ª ×‘×‘× ×™×™×ª ×”×¨×•×‘×•×˜</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>×‘× ×™×™×ª ×”×¨×•×‘×•×˜</h1>

    <p class="Description1">
        ×”×›×™×¨×• ××ª ×”×¨×•×‘×•×˜ ×”×—×™× ×•×›×™ ×©×œ× ×• â€“ ×—×‘×¨ ×—×›× ×•×™×¦×™×¨×ª×™ ×œ×™×œ×“×™×!
        ×”×¨×•×‘×•×˜ ×™×•×“×¢ ×œ×”×§×©×™×‘, ×œ×”×‘×™×Ÿ ×•×œ×“×‘×¨ ×‘×¢×‘×¨×™×ª, ××–×”×” ××—×™××ª ×›×£, ××¦×™×’ ×”×‘×¢×•×ª ×¤× ×™× ××©×ª× ×•×ª, ×¢×•× ×” ×¢×œ ×©××œ×•×ª, ××¡×¤×¨ ×¡×™×¤×•×¨×™×,
        ××©××™×¢ ×¦×œ×™×œ×™×, ×•××’×™×‘ ×‘×¦×•×¨×” ×—×›××” ×œ××¦×‘×™×.
        ×”×•× ××•×¤×¢×œ ×‘×§×œ×•×ª ×“×¨×š ××¡×š ××’×¢ ×•××™×•×¢×“ ×œ×¢×•×¨×¨ ×¡×§×¨× ×•×ª, ×œ×¤×ª×— ×©×™×—×”, ×•×œ×¢×–×•×¨ ×‘×œ××™×“×” ×—×•×•×™×™×ª×™×ª â€“ ×ª×•×š ×©××™×¨×” ×¢×œ ×ª×›× ×™× ××•×ª×××™×
        ×œ×™×œ×“×™×.
    </p>

    <div id="goDownContainer" onclick="document.getElementById('bottom-section').scrollIntoView({behavior:'smooth'})">
        <div class="goDownText">â¬‡ï¸ ×‘×•× × ×¨×“â¬‡ï¸<br> â¬‡ï¸×œ×¢×™× ×™×™×Ÿâ¬‡ï¸</div>
        <img src="images/chevron.png" class="ggg123" alt="×‘×•× × ×¨×“ ×œ×¢× ×™×™×Ÿ">
    </div>

<button id="talkBtn">ğŸ¤ ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×“×‘×¨ ×¢× AI</button>
  <div id="banner">...</div>


    <p class="prohct123">ğŸ‘‡××œ×• ×”×¨×›×™×‘×™× ×©× ×‘×—×¨×• ×œ×¤×¨×•×™×§×˜ğŸ‘‡</p>
    <ul>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="images/Untitled-1.png" alt="Voice Sensor"
                style="max-width: 200px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1);" />
            <br>
            <div style="font-size: 18px; color: #000000; font-weight: 500;">
                ×”××•×— ×¢×¦××• ×©×œ ×”×¤×¨×•×™×™×§×˜ ×”×¨×•×‘×•×˜×™
            </div>
            <br>
            <span style="color: #039be5; font-weight: bold;"> â‚ª1500.00 ×›×•×œ×œ ××¢"×</span>
            <br><br>
            <div style="font-size: 18px; color: #18b318; font-weight: 500;">
             (××¢×‘×“ Rspberry pi 4)<br>
               ×¨×•×‘×•×˜ ×—×›× ×–×” ×™×›×•×œ ×œ×”×™×•×ª ×××© ××‘×“×¨, ×•××¢× ×™×™×Ÿ ×‘×™××™×•×—×“ ×¢× ××¢×¨×›×ª ×”×—×™×‘×•×¨ ×©×œ×•  AI, ×”×œ×‘ ×”×¤×•×¢× ×©×œ ×”××¢×¨×›×ª.
            </div>
            <br>
        </div>
        <br><br>
        <hr style="width: 150px; border: 1px solid #ccc; margin: 20px auto;" />
    </ul>

    <h3>×©×:</h3>
    <input type="text" id="nameInput" placeholder="×”×›× ×¡ ×©×">

    <h3>×‘×—×¨ ××—×•×– ×”×©×ª×ª×¤×•×ª:</h3>
    <select id="percentSelect">
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <br><br>
    <button onclick="submitForm()">×”×©×ª×ª×£ ×‘×‘× ×™×™×ª ×”×¨×•×‘×•×˜</button>
    <br><br>
    <h3 class="ggg">ğŸ‘‡××©×ª×ª×¤×™× ×‘×¤×¨×•×™×™×§×˜ğŸ‘‡</h3>
    <table id="participantsTable">
        <thead>
            <tr>
                <th>×©×</th>
                <th>××—×•×– ×”×©×ª×ª×¤×•×ª</th>
                <th>×¡×›×•× ×‘×¤×•×¢×œ (â‚ª)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="bottom-section"></div>

    <div class="total" id="totalPercent">×¡×”"×› ×”×©×ª×ª×¤×•: 0%</div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
       // âœ… ×™×¦×™×¨×ª ×—×™×‘×•×¨ ×œ-Supabase
const client = window.supabase.createClient(
    "https://fqjfwtspitxhryirivdo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxamZ3dHNwaXR4aHJ5aXJpdmRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5NDM0MzMsImV4cCI6MjA2NTUxOTQzM30.QQPn4JthlXVF1Fb0PzqShbUpzBmA-_WJ9Zc4up4zwKg"
);

const tableBody = document.querySelector("#participantsTable tbody");
const totalPercentEl = document.getElementById("totalPercent");

// âœ… ×˜×¢×™× ×ª ××©×ª×ª×¤×™× ××”-DB
async function loadParticipants() {
    const { data, error } = await client.from("participants").select("*");
    if (error) return console.error("×©×’×™××” ×‘×˜×¢×™× ×”:", error.message);

    tableBody.innerHTML = "";
    let totalPercent = 0;
    const totalPrice = extractPricesFromHTML();

    data.forEach(part => {
        const amount = ((part.percent / 100) * totalPrice).toFixed(2);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${part.name}</td><td>${part.percent}%</td><td>${amount} â‚ª</td>`;
        tableBody.appendChild(tr);
        totalPercent += part.percent;
    });

    totalPercentEl.textContent = `×¡×”\"×› ×”×©×ª×ª×¤×•: ${totalPercent}%`;
}

// âœ… ×©×œ×™×—×ª ××©×ª×ª×£ ×—×“×©
async function submitForm() {
    const name = document.getElementById("nameInput").value.trim();
    const percent = parseInt(document.getElementById("percentSelect").value);
    if (!name || isNaN(percent)) return alert("×× × ××œ× ×©× ×•×‘×—×¨ ××—×•×– ×ª×§×™×Ÿ");

    const { error } = await client.from("participants").insert([{ name, percent }]);
    if (error) return alert("×©×’×™××” ×‘×©×œ×™×—×”: " + error.message);

    document.getElementById("nameInput").value = "";
    document.getElementById("percentSelect").selectedIndex = 0;
    await loadParticipants();
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// âœ… ××—×©×‘ ×¡×›×•× ×›×•×œ×œ ××”-HTML
function extractPricesFromHTML() {
    const spans = document.querySelectorAll("span");
    let total = 0;
    spans.forEach(span => {
        const text = span.textContent;
        let price = 0;
        if (text.includes("â‚ª")) price = parseFloat(text.replace(/[^\d.]/g, ''));
        if (text.includes("$")) {
            const match = text.match(/\$([\d.]+)/g);
            if (match) {
                match.forEach(m => {
                    const val = parseFloat(m.replace("$", ""));
                    price += val * 3.7;
                });
            }
        }
        total += price;
    });
    return total;
}

// âœ… ×˜×¢×™× ×ª ×§×•×‘×¥ ×”×ª×’×•×‘×•×ª ×”×—×›××•×ª (×Ö¾JSON) ×œ×¦×•×¨×š ×–×™×”×•×™ ×ª×’×•×‘×•×ª ××•×›× ×•×ª ××¨××©
let responses = [];

fetch('smart_robot_responses.json')
  .then(res => res.json())
  .then(data => {
    responses = data;
    console.log("âœ… responses × ×˜×¢× ×•:", responses);
  })
  .catch(err => console.error("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×•×‘×•×ª:", err));

// âœ… ×œ××—×¨ ×”×˜×¢×™× ×” â€“ ×”××¢×¨×›×ª ×ª×•×›×œ ×œ×–×”×•×ª ××™×œ×™× ×•×œ×ª×ª ×ª×©×•×‘×•×ª ××•×ª×××•×ª ×œ×¤×™ ×”×§×•×‘×¥

document.addEventListener("DOMContentLoaded", loadParticipants);

async function speak(text) {
  try {
    const res = await fetch("https://polished-sun-142c.netzach3020.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: text })
    });

    const contentType = res.headers.get("Content-Type");

    if (!res.ok || !contentType || !contentType.includes("audio")) {
      const errorText = await res.text();
      console.error("ğŸ”´ ×œ× ×—×–×¨ ××•×“×™×• ×ª×§×™×Ÿ:", errorText);
      fallbackSpeak(text); // ×’×™×‘×•×™ ×¨×’×™×œ
      return;
    }

    const blob = await res.blob();
    const audioURL = URL.createObjectURL(blob);
    const audio = new Audio(audioURL);
    audio.play();
  } catch (err) {
    console.error("ğŸ”´ ×©×’×™××” ×›×œ×œ×™×ª ×‘×§×•×œ:", err);
    fallbackSpeak(text);
  }
}



// âœ… fallback ×œ×“×™×‘×•×¨ ×¨×’×™×œ ××”×“×¤×“×¤×Ÿ
function fallbackSpeak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'he-IL';
  msg.pitch = 1;
  msg.rate = 0.95;
  msg.volume = 1;
  window.speechSynthesis.speak(msg);
}

// âœ… ×¢×“×›×•×Ÿ ×‘×¤×•× ×§×¦×™×” ×©××’×™×‘×” ×œ××©×ª××©
async function respondToUser(userText) {
  const lower = userText.toLowerCase();
  let match = null;

  for (const item of responses) {
    for (const keyword of item.keywords || []) {
      if (lower.includes(keyword)) {
        match = item;
        break;
      }
    }
    if (match) break;
  }

  if (match) {
    showBanner(match.response);
    match.audio ? playAudio(match.audio) : speak(match.response);
  } else {
    const reply = await askGPT(userText);
    showBanner(reply);
    speak(reply); // ××“×‘×¨ ×¢× OpenAI TTS
  }
}


async function askGPT(text) {
  console.log("ğŸ“¤ ×©×•×œ×— ×œÖ¾GPT:", text);
  try {
    const res = await fetch("https://polished-sun-142c.netzach3020.workers.dev", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ prompt: text })
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error("âŒ ×©×’×™××ª ×¨×©×ª:", res.status, errorText);
      return `×©×’×™××ª ×¨×©×ª: ${res.status}`;
    }

    const data = await res.json();
    console.log("ğŸ“¥ ×ª×©×•×‘×” ×Ö¾GPT:", data);
    return data.choices?.[0]?.message?.content || "âŒ ×œ× ×§×™×‘×œ×ª×™ ×ª×©×•×‘×” ××”×©×¨×ª.";
  } catch (error) {
    console.error("âŒ ×©×’×™××”:", error);
    return "âŒ ×©×’×™××” ×‘×©×œ×™×—×” ×œ×©×¨×ª: " + error.message;
  }
}

function startListening() {
  console.log("ğŸ™ï¸ ×”×ª×—×œ×ª ×”××–× ×”...");
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'he-IL';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = async function (event) {
    const transcript = event.results[0][0].transcript.trim();
    console.log("ğŸ—£ï¸ ×–×•×”×” ×˜×§×¡×˜:", transcript);
    const reply = await askGPT(transcript);
    showBanner(reply);
    speak(reply);
  };

  recognition.onerror = function (event) {
    console.error("ğŸ™ï¸ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ:", event.error);
    showBanner("âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ: " + event.error);
  };

  recognition.start();
}

  function showBanner(text) {
    const banner = document.getElementById("banner");
    banner.textContent = text;
    banner.style.display = "block";
  }

  document.getElementById("talkBtn").addEventListener("click", startListening);
    </script>
</body>

</html>
